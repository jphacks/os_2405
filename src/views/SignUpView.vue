<script setup>
import { ref, computed } from 'vue';
import InputMail from '@/components/InputMail.vue';
import InputPassword from '@/components/InputPassword.vue';
import CustomDivider from '@/components/CustomDivider.vue';
import ButtonWithLogo from '@/components/ButtonWithLogo.vue';
import { navigate, areAllFieldsFilled } from '@/function';
import { emailAuth } from '@/auth';
import MessageBox from '@/components/MessageBox.vue';
import { googleLogin } from '@/auth';

const password = ref('');
const passwordConfirmation = ref('');
const email = ref('');
const systemMessage = ref('');
const isError = ref(false);

//メール送信には時間がかかるため、ボタンを押したらローディングを表示する
const emit = defineEmits(['update:loading']);

/**
 * フォームの入力内容を検証し、エラーがなければ登録処理を行う
 */
const submitForm = async () => {
    systemMessage.value = '';
    if (password.value !== passwordConfirmation.value) {
        systemMessage.value = 'パスワードが一致しません';
        isError.value = true;
        return;
    }
    try {
        emit('update:loading', true);
        await emailAuth(email.value, password.value);
        navigate('/mail-send-completed');
    }catch (error) {
        systemMessage.value = error.message;
        isError.value = true;
    }finally {
        emit('update:loading', false);
    }
};

const isShow = computed(() => systemMessage.value !== '');

const buttonFlag = ref(false);

//ボタンが使える場合はtrue、使えない場合はfalse
const buttonStateChange = (isVisible) => {
    // v-btnの有効/無効を切り替える
    // 全てのinputに入力がされるまでボタンを無効にする
    buttonFlag.value = isVisible && areAllFieldsFilled(email.value, password.value, passwordConfirmation.value);
};

/**
 * Googleアカウントでログインする
 */
const onClickGoogleLogin = async () => {
    await googleLogin();
    navigate('/');
};
</script>

<template>
    <h1 class="title">新規登録</h1>
    <div class="my-form">
        <ButtonWithLogo class="center-block" button-text="Googleで登録" :on-click="onClickGoogleLogin"></ButtonWithLogo>
        <CustomDivider text="または" />
        <MessageBox :message="systemMessage" v-show="isShow" :is-error="isError" class="my-5"/>
        <InputMail 
            label="メールアドレス"
            placeholder="sample@example.com" 
            v-model:email="email"
            @error="buttonStateChange"
        />
        <InputPassword 
            label="パスワード"
            placeholder="半角英数字記号のみ" 
            v-model:password="password"
            @error="buttonStateChange"
        /> 
        <InputPassword 
            label="パスワード（再入力）"
            placeholder="半角英数字記号のみ"
            v-model:password="passwordConfirmation"
            @error="buttonStateChange"
        />
        <v-btn
            color="primary"
            class="my-btn font-weight-bold"
            @click="submitForm"
            :disabled="!buttonFlag"
        >
            登録
        </v-btn>

        <v-btn variant="text" color="primary" width="100%" @click="navigate('/login')">
            すでにアカウントを持っています
        </v-btn>
    </div>
</template>

<style scoped>
.title {
    color: #1A69C8;
    text-align: center;
    margin-bottom: 20px;
}

.center-block {
    margin: 20px auto;
}

.center-text {
    text-align: center;
}

.my-form {
    width: 80%;
    margin: 0 auto;
    
    @media (min-width: 1024px) {
        width: 50%;
    }
}

.my-btn {
    width: 100%;
    margin: 20px 0;
}
</style>